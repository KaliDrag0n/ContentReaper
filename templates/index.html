<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <title>Downloader Dashboard</title>
  <style>
    .toast-container { z-index: 1100; }
    .btn-close-custom { padding: 0.2rem 0.4rem; font-size: 0.8rem; }
    .history-buttons .btn { margin-left: 0.25rem; }
    .download-stats { font-size: 0.85rem; }
  </style>
</head>
<body class="bg-light">

  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Job Log</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <pre id="logModalContent" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Downloader Dashboard</h2>
      <a href="/settings" class="btn btn-secondary">Settings</a>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form id="add-job-form">
          <div class="mb-3"><label class="form-label">YouTube URL or Playlist</label><input type="url" name="url" class="form-control" placeholder="https://..." required></div>
          <div class="mb-3"><label class="form-label">Custom Folder Name (optional)</label><input type="text" name="foldername" class="form-control" placeholder="Playlist Folder"></div>
          <div class="row mb-3"><div class="col-md-6"><label class="form-label">Audio Format</label><select name="audio_format" class="form-select"><option value="mp3" selected>MP3</option><option value="flac">FLAC</option><option value="wav">WAV</option><option value="opus">Opus</option></select></div><div class="col-md-6"><label class="form-label">Audio Quality (0=best)</label><select name="audio_quality" class="form-select"><option value="0" selected>0 - Best</option><option value="3">3</option><option value="5">5 - Standard</option><option value="7">7</option><option value="9">9 - Smallest</option></select></div></div>
          <div class="form-check mb-3"><input class="form-check-input" type="checkbox" name="use_archive" value="yes" checked><label class="form-check-label">Use Archive to skip already-downloaded videos</label></div>
          <button type="submit" class="btn btn-primary">Add to Queue</button>
        </form>
      </div>
    </div>
    
    <div class="card mb-4"><div class="card-header bg-info text-white">Now Downloading</div><div class="card-body" id="current-status"><p>No active download.</p></div></div>
    <div class="card mb-4"><div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"><span>Download Queue</span><button class="btn btn-danger btn-sm" id="clear-queue-btn" onclick="clearQueue()">Clear Queue</button></div><ul class="list-group list-group-flush" id="queue-list"></ul></div>
    <div class="card mb-4"><div class="card-header bg-success text-white d-flex justify-content-between align-items-center"><span>Download History</span><button class="btn btn-danger btn-sm" id="clear-history-btn" onclick="clearHistory()">Clear History</button></div><ul class="list-group list-group-flush" id="history-list"></ul></div>
  </div>

<script>
let logModalInstance;
let currentHistoryVersion = -1;

function showToast(message, title = 'Notification', type = 'success') {
    const toastEl = document.getElementById('actionToast');
    const toastTitleEl = document.getElementById('toastTitle');
    const toastBodyEl = document.getElementById('toastBody');
    toastTitleEl.textContent = title;
    toastBodyEl.textContent = message;
    toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');
    toastEl.classList.add(type === 'success' ? 'bg-success' : 'bg-danger', 'text-white');
    new bootstrap.Toast(toastEl).show();
}

async function fetchLog(logId) {
    try {
        const res = await fetch(`/history/log/${logId}`);
        const data = await res.json();
        document.getElementById('logModalContent').textContent = data.log; // .textContent is safe
        logModalInstance.show();
    } catch (error) { showToast('Could not fetch log.', 'Error', 'danger'); }
}

async function postRequest(url, body = null, method = 'POST') {
    try {
        const options = { method };
        if (body) {
            options.body = body instanceof FormData ? body : JSON.stringify(body);
            if (!(body instanceof FormData)) options.headers = { 'Content-Type': 'application/json' };
        }
        const res = await fetch(url, options);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Request failed');
        showToast(data.message, 'Success', 'success');
        fetchStatus();
    } catch (error) { showToast(error.message, 'Error', 'danger'); }
}

const cancelDownload = () => postRequest('/cancel');
const clearQueue = () => postRequest('/queue/clear');
const deleteFromQueueById = (jobId) => postRequest(`/queue/delete/by-id/${jobId}`);
const retryJob = (job) => postRequest('/queue/retry', job);
const refetchJob = (job) => postRequest('/queue/retry', { ...job, refetch: true });
const clearHistory = () => postRequest('/history/clear');
const deleteFromHistory = (logId) => postRequest(`/history/delete/${logId}`);

function renderHistory(history) {
    const historyList = document.getElementById("history-list");
    historyList.innerHTML = "";
    document.getElementById("clear-history-btn").style.display = history.length > 0 ? 'block' : 'none';

    if (history.length === 0) {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = "Nothing in history.";
        historyList.appendChild(li);
        return;
    }

    history.slice().reverse().forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item";

        const mainDiv = document.createElement('div');
        mainDiv.className = 'd-flex justify-content-between align-items-center';

        const leftDiv = document.createElement('div');
        const statusBadge = document.createElement('span');
        statusBadge.className = 'badge me-2';
        statusBadge.textContent = item.status;
        if (item.status === 'COMPLETED') statusBadge.classList.add('bg-success');
        else if (['FAILED', 'ERROR', 'CANCELLED'].includes(item.status)) statusBadge.classList.add('bg-danger');
        else statusBadge.classList.add('bg-secondary');

        const titleStrong = document.createElement('strong');
        titleStrong.textContent = item.title || "Unknown Title";
        leftDiv.appendChild(statusBadge);
        leftDiv.appendChild(titleStrong);

        const buttonDiv = document.createElement('div');
        buttonDiv.className = 'history-buttons';

        const createButton = (text, className, onClick) => {
            const btn = document.createElement('button');
            btn.className = `btn btn-sm ${className}`;
            btn.innerHTML = text; // Using innerHTML for '✖' is fine for static, trusted content
            btn.onclick = onClick;
            return btn;
        };

        buttonDiv.appendChild(createButton('✖', 'btn-outline-danger', () => deleteFromHistory(item.log_id)));
        buttonDiv.appendChild(createButton('View Log', 'btn-info', () => fetchLog(item.log_id)));

        if (['FAILED', 'ERROR', 'CANCELLED'].includes(item.status)) {
            buttonDiv.appendChild(createButton('Retry', 'btn-primary', () => retryJob(item.job_data)));
            if (item.url && item.url.includes("playlist?list=")) {
                buttonDiv.appendChild(createButton('Refetch', 'btn-warning', () => refetchJob(item.job_data)));
            }
        }

        const smallText = document.createElement('small');
        smallText.className = 'text-muted';
        smallText.textContent = `${item.folder ? `Folder: ${item.folder} | ` : ''}URL: ${item.url}`;

        mainDiv.appendChild(leftDiv);
        mainDiv.appendChild(buttonDiv);
        li.appendChild(mainDiv);
        li.appendChild(smallText);
        historyList.appendChild(li);
    });
}

function renderQueue(queue) {
    const queueList = document.getElementById("queue-list");
    queueList.innerHTML = "";
    document.getElementById("clear-queue-btn").style.display = queue.length > 0 ? 'block' : 'none';

    if (queue.length === 0) {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = "Queue is empty.";
        queueList.appendChild(li);
        return;
    }

    queue.forEach(job => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";

        const span = document.createElement("span");
        span.textContent = `${job.url} `;

        if (job.folder) {
            const i = document.createElement("i");
            i.textContent = `→ ${job.folder}`;
            span.appendChild(i);
        }

        const button = document.createElement("button");
        button.className = "btn-close btn-close-custom";
        button.setAttribute("aria-label", "Remove");
        button.onclick = () => deleteFromQueueById(job.id);

        li.appendChild(span);
        li.appendChild(button);
        queueList.appendChild(li);
    });
}

function renderCurrentStatus(current) {
    const currentDiv = document.getElementById("current-status");
    currentDiv.innerHTML = "";

    if (!current) {
        const p = document.createElement("p");
        p.textContent = "No active download.";
        currentDiv.appendChild(p);
        return;
    }

    const cancelButton = document.createElement("button");
    cancelButton.className = "btn btn-danger btn-sm float-end";
    cancelButton.textContent = "Cancel";
    cancelButton.onclick = cancelDownload;
    
    const titleP = document.createElement("p");
    const titleStrong = document.createElement("strong");
    titleStrong.textContent = current.title || current.url;
    titleP.appendChild(titleStrong);

    if (current.playlist_count > 0) {
        const playlistBadge = document.createElement("span");
        playlistBadge.className = "ms-2 badge bg-secondary";
        playlistBadge.textContent = `${current.playlist_index || '0'}/${current.playlist_count}`;
        titleP.appendChild(playlistBadge);
    }
    
    const progressDiv = document.createElement("div");
    progressDiv.className = "progress mb-2";
    const progressBar = document.createElement("div");
    const progress = current.progress || 0;
    progressBar.className = "progress-bar progress-bar-striped progress-bar-animated";
    progressBar.style.width = `${progress}%`;
    progressBar.style.transition = "width 0.5s ease";
    progressBar.textContent = `${progress.toFixed(1)}%`;
    progressDiv.appendChild(progressBar);

    const statusP = document.createElement("p");
    statusP.className = "mb-1";
    statusP.textContent = current.status;

    const statsDiv = document.createElement("div");
    statsDiv.className = "d-flex justify-content-between mt-2 download-stats";
    statsDiv.innerHTML = `<small class="text-muted">Size: ${current.file_size || 'N/A'}</small><small class="text-muted">Speed: ${current.speed || 'N/A'}</small><small class="text-muted">ETA: ${current.eta || 'N/A'}</small>`;

    currentDiv.append(cancelButton, titleP, progressDiv, statusP, statsDiv);
}

async function fetchStatus() {
    try {
        const res = await fetch("/status");
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        const data = await res.json();

        renderCurrentStatus(data.current);
        renderQueue(data.queue);

        if (data.history_version !== currentHistoryVersion) {
            currentHistoryVersion = data.history_version;
            const historyRes = await fetch("/history");
            const historyData = await historyRes.json();
            renderHistory(historyData.history);
        }

    } catch (error) {
        console.error("Failed to fetch or render status:", error);
        document.getElementById("current-status").innerHTML = `<div class="alert alert-danger"><strong>Dashboard Error:</strong> Could not update status. Check console.</div>`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    logModalInstance = new bootstrap.Modal(document.getElementById('logModal'));
    document.getElementById('add-job-form').addEventListener('submit', function(e) {
        e.preventDefault();
        postRequest('/queue', new FormData(this));
        this.reset();
    });
    
    fetchStatus();
    setInterval(fetchStatus, 2000);
});
</script>
</body>
</html>