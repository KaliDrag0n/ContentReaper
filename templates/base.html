<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}{{ app_name }}{% endblock %}</title>

  <meta name="csrf-token" content="{{ csrf_token() }}">

  {# Pre-load theme to prevent flash of unstyled content #}
  <script>
    (function() {
      const savedTheme = localStorage.getItem('downloader_theme') || 'light';
      document.documentElement.dataset.bsTheme = savedTheme;
    })();
  </script>

  {# External Libraries #}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  {# App-specific JS with defer to load after DOM parsing #}
  <script src="{{ url_for('static', filename='js/api.js') }}" defer></script>
  <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
  
  {# Page-specific scripts will be injected here #}
  {% block scripts %}{% endblock %}

  <style>
    :root {
        --bs-body-bg: #f8f9fa;
        --bs-body-color: #212529;
        --bs-border-color: #dee2e6;
        --bs-card-bg: #fff;
    }
    [data-bs-theme="dark"] {
        --bs-body-bg: #212529;
        --bs-body-color: #dee2e6;
        --bs-border-color: #495057;
        --bs-card-bg: #343a40;
    }
    body {
        transition: background-color 0.2s linear, color 0.2s linear;
    }
    main {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    body.loaded main {
        opacity: 1;
    }
    .word-break {
        word-break: break-word;
    }
    /* Hide permission-controlled elements by default */
    .perm-admin, .perm-can_add_to_queue, .perm-can_manage_scythes, .perm-can_download_files, .perm-can_delete_files {
        display: none;
    }
    /* Ensure nav tabs don't wrap on small screens */
    .nav-tabs .nav-link {
        white-space: nowrap;
    }
    .nav-tabs-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        scrollbar-width: none; /* Hide scrollbar for Firefox */
    }
    .nav-tabs-container::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome, Safari, and Opera */
    }
    {% block styles %}{% endblock %}
  </style>
</head>
<body>

  {# Shared Modals #}
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1150;">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle"></strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login Required</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="login-form">
            <div class="mb-3">
              <label for="login-username-input" class="form-label">Username</label>
              <input type="text" class="form-control" id="login-username-input" value="admin" required>
            </div>
            <div class="mb-3">
              <label for="login-password-input" class="form-label">Password</label>
              <input type="password" class="form-control" id="login-password-input" required>
            </div>
            <div id="login-error" class="text-danger small mb-3"></div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalTitle">Are you sure?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmModalButton">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <header class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h2 class="m-0 mb-3 mb-md-0">
            <i class="bi bi-cloud-arrow-down-fill"></i> {{ app_name }}
        </h2>
        <div class="d-flex align-items-center">
            <button class="btn btn-success me-3" id="login-btn" style="display: none;"><i class="bi bi-box-arrow-in-right"></i> Login</button>
            <button class="btn btn-warning me-3" id="logout-btn" style="display: none;"><i class="bi bi-box-arrow-right"></i> Logout</button>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="theme-toggle">
                <label class="form-check-label" for="theme-toggle"><i class="bi bi-moon-stars-fill"></i></label>
            </div>
        </div>
    </header>

    <div class="nav-tabs-container mb-4">
        <ul class="nav nav-tabs flex-nowrap">
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'index_route' %}active{% endif %}" href="{{ url_for('index_route') }}">
                    <i class="bi bi-house-fill d-none d-sm-inline"></i> Downloader
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.endpoint == 'file_manager_route' %}active{% endif %}" href="{{ url_for('file_manager_route') }}">
                    <i class="bi bi-folder-fill d-none d-sm-inline"></i> File Manager
                </a>
            </li>
            <li class="nav-item perm-admin">
                <a class="nav-link {% if request.endpoint == 'settings_route' %}active{% endif %}" href="{{ url_for('settings_route') }}">
                    <i class="bi bi-gear-fill d-none d-sm-inline"></i> Settings
                </a>
            </li>
            {# CHANGE: Add new "Logs" tab, visible only to admins. #}
            <li class="nav-item perm-admin">
                <a class="nav-link {% if request.endpoint == 'logs_route' %}active{% endif %}" href="{{ url_for('logs_route') }}">
                    <i class="bi bi-file-text-fill d-none d-sm-inline"></i> Logs
                </a>
            </li>
        </ul>
    </div>

    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

  </div>

</body>
</html>
